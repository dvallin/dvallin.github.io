!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=8)}([function(t,e,i){"use strict";const s=2.3283064365386963e-10;class n{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*s,t=69069*t+1>>>0,this._s1=t*s,t=69069*t+1>>>0,this._s2=t*s,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*s;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,n;do{n=(i=2*this.getUniform()-1)*i+(s=2*this.getUniform()-1)*s}while(n>1||0==n);return t+i*Math.sqrt(-2*Math.log(n)/n)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,n=0;for(i in t)if(s<(n+=t[i]))return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new n).setState(this.getState())}}e.a=(new n).setSeed(Date.now())},function(t,e,i){"use strict";function s(t,e){return(t%e+e)%e}function n(t,e=0,i=1){return t<e?e:t>i?i:t}function o(t){return t.charAt(0).toUpperCase()+t.substring(1)}function r(t,...e){let i=r.map;return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(s,n,r,a){if("%"==t.charAt(a-1))return s.substring(1);if(!e.length)return s;let h=e[0],c=(n||r).split(","),l=c.shift()||"",u=i[l.toLowerCase()];if(!u)return s;let d=(h=e.shift())[u].apply(h,c),p=l.charAt(0);return p!=p.toLowerCase()&&(d=o(d)),d})}i.r(e),i.d(e,"mod",function(){return s}),i.d(e,"clamp",function(){return n}),i.d(e,"capitalize",function(){return o}),i.d(e,"format",function(){return r}),r.map={s:"toString"}},function(t,e,i){"use strict";i.r(e),i.d(e,"fromString",function(){return o}),i.d(e,"add",function(){return r}),i.d(e,"add_",function(){return a}),i.d(e,"multiply",function(){return h}),i.d(e,"multiply_",function(){return c}),i.d(e,"interpolate",function(){return l}),i.d(e,"lerp",function(){return u}),i.d(e,"interpolateHSL",function(){return d}),i.d(e,"lerpHSL",function(){return p}),i.d(e,"randomize",function(){return g}),i.d(e,"rgb2hsl",function(){return f}),i.d(e,"hsl2rgb",function(){return w}),i.d(e,"toRGB",function(){return _}),i.d(e,"toHex",function(){return y});var s=i(1),n=i(0);function o(t){let e,i;if(t in v)e=v[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];v[t]=e}return e.slice()}function r(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let s=0;s<e.length;s++)i[t]+=e[s][t];return i}function a(t,...e){for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}function h(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let s=0;s<e.length;s++)i[t]*=e[s][t]/255;i[t]=Math.round(i[t])}return i}function c(t,...e){for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t}function l(t,e,i=.5){let s=t.slice();for(let n=0;n<3;n++)s[n]=Math.round(s[n]+i*(e[n]-t[n]));return s}const u=l;function d(t,e,i=.5){let s=f(t),n=f(e);for(let t=0;t<3;t++)s[t]+=i*(n[t]-s[t]);return w(s)}const p=d;function g(t,e){e instanceof Array||(e=Math.round(n.a.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(n.a.getNormal(0,e[t])):e;return i}function f(t){let e,i=t[0]/255,s=t[1]/255,n=t[2]/255,o=Math.max(i,s,n),r=Math.min(i,s,n),a=0,h=(o+r)/2;if(o==r)e=0;else{let t=o-r;switch(e=h>.5?t/(2-o-r):t/(o+r),o){case i:a=(s-n)/t+(s<n?6:0);break;case s:a=(n-i)/t+2;break;case n:a=(i-s)/t+4}a/=6}return[a,e,h]}function m(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function w(t){let e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];{let i=t[1],s=e<.5?e*(1+i):e+i-e*i,n=2*e-s,o=m(n,s,t[0]+1/3),r=m(n,s,t[0]),a=m(n,s,t[0]-1/3);return[Math.round(255*o),Math.round(255*r),Math.round(255*a)]}}function _(t){return`rgb(${t.map(t=>Object(s.clamp)(t,0,255)).join(",")})`}function y(t){return`#${t.map(t=>Object(s.clamp)(t,0,255).toString(16).padStart(2,"0")).join("")}`}const v={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},function(t,e,i){"use strict";i.d(e,"a",function(){return s});class s{getContainer(){return null}setOptions(t){this._options=t}}},function(t,e,i){"use strict";(function(t){i.d(e,"a",function(){return r});var s=i(3),n=i(2);function o(t){let e=n.fromString(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class r extends s.a{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){t.stdout.write(`[0;48;5;${o(this._options.bg)}m[2J`)}draw(e,i){let[s,n,r,a,h]=e,c=this._offset[0]+s,l=this._offset[1]+n,u=this.computeSize();if(c<0||c>=u[0])return;if(l<0||l>=u[1])return;if(c===this._cursor[0]&&l===this._cursor[1]||(t.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(c,l)),this._cursor[0]=c,this._cursor[1]=l),i&&(r||(r=" ")),!r)return;let d=function(t,e){return`[0;38;5;${o(t)};48;5;${o(e)}m`}(a,h);d!==this._lastColor&&(t.stdout.write(d),this._lastColor=d);let p=[].concat(r);t.stdout.write(p[0]),this._cursor[0]++,this._cursor[0]>=u[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[t.stdout.columns,t.stdout.rows]}}}).call(this,i(6))},function(t,e,i){"use strict";var s=i(7),n=function(){var t=4022871197;return function(e){if(e){e=e.toString();for(var i=0;i<e.length;i++){var s=.02519603282416938*(t+=e.charCodeAt(i));s-=t=s>>>0,t=(s*=t)>>>0,t+=4294967296*(s-=t)}return 2.3283064365386963e-10*(t>>>0)}t=4022871197}},o=function(t){return function(){var e,i,o=48,r=1,a=o,h=new Array(o),c=0,l=new n;for(e=0;e<o;e++)h[e]=l(Math.random());var u=function(){++a>=o&&(a=0);var t=1768863*h[a]+2.3283064365386963e-10*r;return h[a]=t-(r=0|t)},d=function(t){return Math.floor(t*(u()+1.1102230246251565e-16*(2097152*u()|0)))};d.string=function(t){var e,i="";for(e=0;e<t;e++)i+=String.fromCharCode(33+d(94));return i};return d.cleanString=function(t){return t=(t=(t=t.replace(/(^\s*)|(\s*$)/gi,"")).replace(/[\x00-\x1F]/gi,"")).replace(/\n /,"\n")},d.hashString=function(t){for(t=d.cleanString(t),l(t),e=0;e<t.length;e++)for(c=t.charCodeAt(e),i=0;i<o;i++)h[i]-=l(c),h[i]<0&&(h[i]+=1)},d.seed=function(t){null==t&&(t=Math.random()),"string"!=typeof t&&(t=s(t,function(t,e){return"function"==typeof e?e.toString():e})),d.initState(),d.hashString(t)},d.addEntropy=function(){var t=[];for(e=0;e<arguments.length;e++)t.push(arguments[e]);!function(){var t=Array.prototype.slice.call(arguments);for(e=0;e<t.length;e++)for(i=0;i<o;i++)h[i]-=l(t[e]),h[i]<0&&(h[i]+=1)}(c+++(new Date).getTime()+t.join("")+Math.random())},d.initState=function(){for(l(),e=0;e<o;e++)h[e]=l(" ");r=1,a=o},d.done=function(){l=null},void 0!==t&&d.seed(t),d.range=function(t){return d(t)},d.random=function(){return d(Number.MAX_VALUE-1)/Number.MAX_VALUE},d.floatBetween=function(t,e){return d.random()*(e-t)+t},d.intBetween=function(t,e){return Math.floor(d.random()*(e-t+1))+t},d}()};o.create=function(t){return new o(t)},t.exports=o},function(t,e){var i,s,n=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{s="function"==typeof clearTimeout?clearTimeout:r}catch(t){s=r}}();var h,c=[],l=!1,u=-1;function d(){l&&h&&(l=!1,h.length?c=h.concat(c):u=-1,c.length&&p())}function p(){if(!l){var t=a(d);l=!0;for(var e=c.length;e;){for(h=c,c=[];++u<e;)h&&h[u].run();u=-1,e=c.length}h=null,l=!1,function(t){if(s===clearTimeout)return clearTimeout(t);if((s===r||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(t);try{s(t)}catch(e){try{return s.call(null,t)}catch(e){return s.call(this,t)}}}(t)}}function g(t,e){this.fun=t,this.array=e}function f(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];c.push(new g(t,e)),1!==c.length||l||a(p)},g.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=f,n.addListener=f,n.once=f,n.off=f,n.removeListener=f,n.removeAllListeners=f,n.emit=f,n.prependListener=f,n.prependOnceListener=f,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},function(t,e){function i(t,e){var i=[],s=[];return null==e&&(e=function(t,e){return i[0]===e?"[Circular ~]":"[Circular ~."+s.slice(0,i.indexOf(e)).join(".")+"]"}),function(n,o){if(i.length>0){var r=i.indexOf(this);~r?i.splice(r+1):i.push(this),~r?s.splice(r,1/0,n):s.push(n),~i.indexOf(o)&&(o=e.call(this,n,o))}else i.push(o);return null==t?o:t.call(this,n,o)}}(t.exports=function(t,e,s,n){return JSON.stringify(t,i(e,n),s)}).getSerialize=i},function(t,e,i){"use strict";i.r(e);var s={};i.r(s),i.d(s,"TYPE_TEXT",function(){return b}),i.d(s,"TYPE_NEWLINE",function(){return k}),i.d(s,"TYPE_FG",function(){return C}),i.d(s,"TYPE_BG",function(){return S}),i.d(s,"measure",function(){return E}),i.d(s,"tokenize",function(){return x});class n{constructor(t,e){this.world=t,this.entity=e}withComponent(t,e){return this.world.getStorage(t).insert(this.entity,e),this}removeComponent(t){return this.world.getStorage(t).remove(this.entity),this}delete(){this.world.components.forEach(t=>t.remove(this.entity))}}class o{constructor(){this.components=new Map,this.resources=new Map,this.systems=new Map,this.emptySystems=new Set,this.activeSystems=new Set,this.openEntities=new Set,this.lastEntity=-1}get entityCount(){return this.lastEntity+1-this.openEntities.size}registerComponentStorage(t,e){this.components.set(t,e)}getStorage(t){return this.components.get(t)}getResource(t){return this.resources.get(t)}getComponent(t,e){const i=this.getStorage(e);if(void 0!==i)return i.get(t)}hasComponent(t,e){const i=this.getStorage(e);return void 0!==i&&i.has(t)}createEntity(){let t;return this.openEntities.size>0?(t=this.openEntities.values().next().value,this.openEntities.delete(t)):t=++this.lastEntity,new n(this,t)}editEntity(t){return new n(this,t)}deleteEntity(t){this.editEntity(t).delete(),this.openEntities.add(t)}registerSystem(t,e){this.systems.set(t,e)}enableSystem(t){this.activeSystems.add(t)}disableSystem(t){this.activeSystems.delete(t)}registerResource(t){this.resources.set(t.kind,t)}updateResources(){for(const t of this.resources)t[1].update(this)}updateSystems(){this.emptySystems.clear();for(const t of this.activeSystems){const e=this.systems.get(t),i=this.getStorage(e.components[0]);let s=0;i.foreach(t=>{let i=!0;for(let s=1;s<e.components.length;s++)if(!this.hasComponent(t,e.components[s])){i=!1;break}i&&(e.update(this,t),s++)}),0===s&&this.emptySystems.add(t)}}}class r{constructor(){this.data=new Set}size(){return this.data.size}insert(t,{}){this.data.add(t)}clear(){this.data.clear()}get(t){return this.data.has(t)?{}:void 0}remove(t){return this.data.delete(t)?{}:void 0}has(t){return this.data.has(t)}foreach(t){this.data.forEach(e=>t(e,{}))}}class a{constructor(){this.datum=void 0,this.value=void 0}size(){return void 0!==this.datum?1:0}insert(t,e){this.datum=t,this.value=e}clear(){this.datum=void 0}get(t){return this.datum===t?this.value:void 0}remove(t){if(this.datum===t)return this.datum=void 0,this.value}has(t){return this.datum===t}foreach(t){void 0!==this.datum&&t(this.datum,this.value)}}class h{constructor(){this.data=new Map}size(){return this.data.size}insert(t,e){this.data.set(t,e)}clear(){this.data.clear()}get(t){return this.data.get(t)}remove(t){const e=this.get(t);return this.data.delete(t),e}has(t){return this.data.has(t)}foreach(t){this.data.forEach((e,i)=>t(i,e))}}class c{constructor(){this.data=[],this.count=0}size(){return this.count}insert(t,e){void 0===this.data[t]&&this.count++,this.data[t]=e}clear(){this.data=[]}get(t){return this.data[t]}remove(t){void 0!==this.data[t]&&this.count--;const e=this.get(t);return this.data[t]=void 0,e}has(t){return void 0!==this.data[t]}foreach(t){for(let e=0;e<this.data.length;e++){const i=this.data[e];void 0!==i&&t(e,i)}}}class l{constructor(){this.objects=new Map}get(t){return this.objects.get(t.key)}set(t,e){this.objects.set(t.key,e)}setAll(t,e){t.foreach(t=>this.set(t,e))}remove(t){const e=t.key,i=this.objects.get(e);return this.objects.delete(e),i}}class u{constructor(){this.objects=new Map}get(t){return this.objects.get(t.key)||[]}set(t,e){this.objects.set(t.key,e)}add(t,e){const i=t.key,s=this.objects.get(i)||[];s.push(e),this.objects.set(i,s)}addAll(t,e){t.foreach(t=>this.add(t,e))}retain(t,e){const i=t.key,s=this.objects.get(i)||[];this.objects.set(i,s.filter(t=>e(t)))}}class d{static fromDirection(t){switch(t){case"up":return new d(0,-1);case"right":return new d(1,0);case"down":return new d(0,1);case"left":return new d(-1,0)}}static interpolate(t,e,i){return d.assertHasSameDimensions(t,e),t.add(e.minus(t).mult(i))}static assertHasSameDimensions(t,e){if(t.dimensions!==e.dimensions)throw new Error("dimension mismatch")}constructor(...t){this.coordinates=t}get key(){return this.coordinates.join(",")}get dimensions(){return this.coordinates.length}get center(){return this.add(new d(.5,.25))}get x(){return this.coordinates[0]}get y(){return this.coordinates[1]}get z(){return this.coordinates[2]}at(t){return this.coordinates[t]}equals(t){if(t.dimensions!==this.dimensions)return!1;for(let e=0;e<this.dimensions;e++)if(this.at(e)!==t.at(e))return!1;return!0}add(t){d.assertHasSameDimensions(this,t);const e=[];for(let i=0;i<this.dimensions;i++)e.push(this.at(i)+t.at(i));return new d(...e)}minus(t){d.assertHasSameDimensions(this,t);const e=[];for(let i=0;i<this.dimensions;i++)e.push(this.at(i)-t.at(i));return new d(...e)}floor(){const t=[];for(let e=0;e<this.dimensions;e++)t.push(Math.floor(this.at(e)));return new d(...t)}mult(t){const e=[];for(let i=0;i<this.dimensions;i++)e.push(this.at(i)*t);return new d(...e)}abs(){const t=[];for(let e=0;e<this.dimensions;e++)t.push(Math.abs(this.at(e)));return new d(...t)}bounds(t){d.assertHasSameDimensions(this,t);for(let e=0;e<this.dimensions;e++)if(Math.abs(t.at(e))>=Math.abs(this.at(e)))return!1;return!0}perpendicular(){if(2!==this.dimensions)throw new Error("wrong dimension");return new d(-this.y,this.x)}squaredLength(){let t=0;for(let e=0;e<this.dimensions;e++)t+=this.at(e)*this.at(e);return t}length(){return Math.sqrt(this.squaredLength())}l1(){let t=0;for(let e=0;e<this.dimensions;e++)t+=Math.abs(this.at(e));return t}lN(){let t=0;for(let e=0;e<this.dimensions;e++)t=Math.max(t,Math.abs(this.at(e)));return t}normalize(){return this.mult(1/this.length())}isNan(){for(let t=0;t<this.dimensions;t++)if(Number.isNaN(this.at(t)))return!0;return!1}}i(0);var p=i(3);class g extends p.a{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}var f=i(1);class m extends g{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,n,o,r]=t,a=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=r,this._fill(a[0],a[1])),!n)return;this._ctx.fillStyle=o;let h=[].concat(n);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],a[0],Math.ceil(a[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),n=Math.min(i,s),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;let a=r/100,h=2*(n=Math.floor(n)+1)/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return e=Math.floor(e/s),Object(f.mod)(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const n=this._ctx;n.beginPath(),this._options.transpose?(n.moveTo(t-i+s,e),n.lineTo(t-i/2+s,e+this._spacingX-s),n.lineTo(t+i/2-s,e+this._spacingX-s),n.lineTo(t+i-s,e),n.lineTo(t+i/2-s,e-this._spacingX+s),n.lineTo(t-i/2+s,e-this._spacingX+s),n.lineTo(t-i+s,e)):(n.moveTo(t,e-i+s),n.lineTo(t+this._spacingX-s,e-i/2+s),n.lineTo(t+this._spacingX-s,e+i/2-s),n.lineTo(t,e+i-s),n.lineTo(t-this._spacingX+s,e+i/2-s),n.lineTo(t-this._spacingX+s,e-i/2+s),n.lineTo(t,e-i+s)),n.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class w extends g{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){w.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,n,o,r]=t,a=""+n+o+r;if(a in this._canvasCache)e=this._canvasCache[a];else{let t=this._options.border,i=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=r,i.fillRect(t,t,e.width-t,e.height-t),n){i.fillStyle=o,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(n);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,n,o,r]=t;if(e){let t=this._options.border;this._ctx.fillStyle=r,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!n)return;this._ctx.fillStyle=o;let a=[].concat(n);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let r=o/100*s/i;return r>1&&(s=Math.floor(s/r)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}w.cache=!1;class _ extends g{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,n,o,r]=t,a=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*a,s*h,a,h):(this._ctx.fillStyle=r,this._ctx.fillRect(i*a,s*h,a,h))),!n)return;let c=[].concat(n),l=[].concat(o),u=[].concat(r);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);if(this._options.tileColorize){let n=this._colorCanvas,o=n.getContext("2d");o.globalCompositeOperation="source-over",o.clearRect(0,0,a,h);let r=l[t],c=u[t];o.drawImage(this._options.tileSet,e[0],e[1],a,h,0,0,a,h),"transparent"!=r&&(o.fillStyle=r,o.globalCompositeOperation="source-atop",o.fillRect(0,0,a,h)),"transparent"!=c&&(o.fillStyle=c,o.globalCompositeOperation="destination-over",o.fillRect(0,0,a,h)),this._ctx.drawImage(n,i*a,s*h,a,h)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],a,h,i*a,s*h,a,h)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}var y=i(4);const v=/%([bc]){([^}]*)}/g,b=0,k=1,C=2,S=3;function E(t,e){let i={width:0,height:1},s=x(t,e),n=0;for(let t=0;t<s.length;t++){let e=s[t];switch(e.type){case b:n+=e.value.length;break;case k:i.height++,i.width=Math.max(i.width,n),n=0}}return i.width=Math.max(i.width,n),i}function x(t,e){let i=[],s=0;t.replace(v,function(e,n,o,r){let a=t.substring(s,r);return a.length&&i.push({type:b,value:a}),i.push({type:"c"==n?C:S,value:o.trim()}),s=r+e.length,""});let n=t.substring(s);return n.length&&i.push({type:b,value:n}),function(t,e){e||(e=1/0);let i=0,s=0,n=-1;for(;i<t.length;){let o=t[i];if(o.type==k&&(s=0,n=-1),o.type!=b){i++;continue}for(;0==s&&" "==o.value.charAt(0);)o.value=o.value.substring(1);let r=o.value.indexOf("\n");if(-1!=r){o.value=V(t,i,r,!0);let e=o.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();o.value=e.join("")}if(o.value.length){if(s+o.value.length>e){let r=-1;for(;;){let t=o.value.indexOf(" ",r+1);if(-1==t)break;if(s+t>e)break;r=t}if(-1!=r)o.value=V(t,i,r,!0);else if(-1!=n){let e=t[n],s=e.value.lastIndexOf(" ");e.value=V(t,n,s,!0),i=n}else o.value=V(t,i,e-s,!1)}else s+=o.value.length,-1!=o.value.indexOf(" ")&&(n=i);i++}else t.splice(i,1)}t.push({type:k});let o=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case b:o=i;break;case k:if(o){let t=o.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();o.value=t.join("")}o=null}}return t.pop(),t}(i,e)}function V(t,e,i,s){let n={type:k},o={type:b,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,n,o),t[e].value.substring(0,i)}let M=80,K=25;const L={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},T={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},R={hex:m,rect:w,tile:_,term:y.a},A={width:M,height:K,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class O{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},A,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=R[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,n){s||(s=this._options.fg),n||(n=this._options.bg);let o=`${t},${e}`;this._data[o]=[t,e,i,s,n],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawText(t,e,i,s){let n=null,o=null,r=t,a=e,h=1;s||(s=this._options.width-t);let c=x(i,s);for(;c.length;){let e=c.shift();switch(e.type){case b:let i=!1,s=!1,c=!1,l=!1;for(let t=0;t<e.value.length;t++){let h=e.value.charCodeAt(t),u=e.value.charAt(t);c=h>65280&&h<65377||h>65500&&h<65512||h>65518,i=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!l||c||i||r++,c&&!s&&r++,this.draw(r++,a,u,n,o),s=i,l=c}break;case C:n=e.value||null;break;case S:o=e.value||null;break;case k:r=t,a++,h++}}return h}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}O.Rect=w,O.Hex=m,O.Tile=_,O.Term=y.a;class P{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,n,o,r=[];switch(this._options.topology){case 4:n=1,o=[0,1],s=[L[8][7],L[8][1],L[8][3],L[8][5]];break;case 6:s=L[6],n=1,o=[-1,1];break;case 8:s=L[4],n=2,o=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let a=t+o[0]*i,h=e+o[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*n;e++)r.push([a,h]),a+=s[t][0],h+=s[t][1];return r}}const D=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];var N={DiscreteShadowcasting:class extends P{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let n,o,r,a,h,c=[];for(let l=1;l<=i;l++){let i=this._getCircle(t,e,l),u=360/i.length;for(let t=0;t<i.length;t++)if(r=i[t][0],a=i[t][1],o=(n=u*(t-.5))+u,h=!this._lightPasses(r,a),this._visibleCoords(Math.floor(n),Math.ceil(o),h,c)&&s(r,a,l,1),2==c.length&&0==c[0]&&360==c[1])return}}_visibleCoords(t,e,i,s){if(t<0){let n=this._visibleCoords(0,e,i,s),o=this._visibleCoords(360+t,360,i,s);return n||o}let n=0;for(;n<s.length&&s[n]<t;)n++;if(n==s.length)return i&&s.push(t,e),!0;let o=0;if(n%2){for(;n<s.length&&s[n]<e;)n++,o++;return 0!=o&&(i&&(o%2?s.splice(n-o,o,e):s.splice(n-o,o)),!0)}for(;n<s.length&&s[n]<e;)n++,o++;return(t!=s[n-o]||1!=o)&&(i&&(o%2?s.splice(n-o,o,t):s.splice(n-o,o,t,e)),!0)}},PreciseShadowcasting:class extends P{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let n,o,r,a,h,c,l=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),d=i.length;for(let t=0;t<d;t++)if(n=i[t][0],o=i[t][1],a=[t?2*t-1:2*d-1,2*d],h=[2*t+1,2*d],r=!this._lightPasses(n,o),(c=this._checkVisibility(a,h,r,l))&&s(n,o,u,c),2==l.length&&0==l[0][0]&&l[1][0]==l[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let n=0,o=!1;for(;n<s.length;){let e=s[n],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||n%2||(o=!0);break}n++}let r=s.length,a=!1;for(;r--;){let t=s[r],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&r%2&&(a=!0);break}}let h,c=!0;if(n==r&&(o||a)?c=!1:o&&a&&n+1==r&&r%2?c=!1:n>r&&n%2&&(c=!1),!c)return 0;let l=r-n+1;if(l%2)if(n%2){let t=s[n];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,l,e)}else{let e=s[r];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,l,t)}else{if(!(n%2))return i&&s.splice(n,l,t,e),1;{let t=s[n],e=s[r];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,l)}}return h/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}},RecursiveShadowcasting:class extends P{compute(t,e,i,s){s(t,e,0,1);for(let n=0;n<D.length;n++)this._renderOctant(t,e,D[n],i,s)}compute180(t,e,i,s,n){n(t,e,0,1);let o=(s-1+8)%8,r=(s-2+8)%8,a=(s+1+8)%8;this._renderOctant(t,e,D[r],i,n),this._renderOctant(t,e,D[o],i,n),this._renderOctant(t,e,D[s],i,n),this._renderOctant(t,e,D[a],i,n)}compute90(t,e,i,s,n){n(t,e,0,1);let o=(s-1+8)%8;this._renderOctant(t,e,D[s],i,n),this._renderOctant(t,e,D[o],i,n)}_renderOctant(t,e,i,s,n){this._castVisibility(t,e,1,1,0,s+1,i[0],i[1],i[2],i[3],n)}_castVisibility(t,e,i,s,n,o,r,a,h,c,l){if(!(s<n))for(let u=i;u<=o;u++){let i=-u-1,d=-u,p=!1,g=0;for(;i<=0;){let f=t+(i+=1)*r+d*a,m=e+i*h+d*c,w=(i-.5)/(d+.5),_=(i+.5)/(d-.5);if(!(_>s)){if(w<n)break;if(i*i+d*d<o*o&&l(f,m,u,1),p){if(!this._lightPasses(f,m)){g=_;continue}p=!1,s=g}else!this._lightPasses(f,m)&&u<o&&(p=!0,this._castVisibility(t,e,u+1,s,w,o,r,a,h,c,l),g=_)}}if(p)break}}}};Math.sqrt(3),Math.sqrt(3);var B=i(2);class F{constructor(t,e={}){this._reflectivityCallback=t,this._options={},e=Object.assign({passes:1,emissionThreshold:100,range:10},e),this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(e)}setOptions(t){return Object.assign(this._options,t),t&&t.range&&this.reset(),this}setFOV(t){return this._fov=t,this._fovCache={},this}setLight(t,e,i){let s=t+","+e;return i?this._lights[s]="string"==typeof i?B.fromString(i):i:delete this._lights[s],this}clearLights(){this._lights={}}reset(){return this._reflectivityCache={},this._fovCache={},this}compute(t){let e={},i={},s={};for(let t in this._lights){let e=this._lights[t];i[t]=[0,0,0],B.add_(i[t],e)}for(let t=0;t<this._options.passes;t++)this._emitLight(i,s,e),t+1!=this._options.passes&&(i=this._computeEmitters(s,e));for(let e in s){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]),s[e])}return this}_emitLight(t,e,i){for(let s in t){let n=s.split(","),o=parseInt(n[0]),r=parseInt(n[1]);this._emitLightFromCell(o,r,t[s],e),i[s]=1}return this}_computeEmitters(t,e){let i={};for(let s in t){if(s in e)continue;let n,o=t[s];if(s in this._reflectivityCache)n=this._reflectivityCache[s];else{let t=s.split(","),e=parseInt(t[0]),i=parseInt(t[1]);n=this._reflectivityCallback(e,i),this._reflectivityCache[s]=n}if(0==n)continue;let r=[0,0,0],a=0;for(let t=0;t<3;t++){let e=Math.round(o[t]*n);r[t]=e,a+=e}a>this._options.emissionThreshold&&(i[s]=r)}return i}_emitLightFromCell(t,e,i,s){let n,o=t+","+e;n=o in this._fovCache?this._fovCache[o]:this._updateFOV(t,e);for(let t in n){let e,o=n[t];t in s?e=s[t]:(e=[0,0,0],s[t]=e);for(let t=0;t<3;t++)e[t]+=Math.round(i[t]*o)}return this}_updateFOV(t,e){let i=t+","+e,s={};this._fovCache[i]=s;let n=this._options.range;return this._fov.compute(t,e,n,function(t,e,i,o){let r=o*(1-i/n);0!=r&&(s[t+","+e]=r)}.bind(this)),s}}const z=B;class I{constructor(t){this.color=t,this.rgb=z.toRGB(t)}static fromHex(t){return new I(z.fromString(t))}add(t){return new I(z.add(this.color,t.color))}multiply(t){return new I(z.multiply(this.color,t.color))}}const U=[I.fromHex("#FD971F"),I.fromHex("#A6E22E"),I.fromHex("#66D9EF"),I.fromHex("#F92672"),I.fromHex("#272822")],H=[I.fromHex("#E6E6E6"),I.fromHex("#6f7261"),I.fromHex("#46483d"),I.fromHex("#272822"),I.fromHex("#080807")],j=["Æ’","Ã¥","ÃŸ","Ï€","â€ ","Â¡","âˆž","â€¢","âˆ‚","âˆ†","Â¬","â€¦","â‰ˆ","Ã§","Âµ","Ã","âˆ","Ã","ÃŽ","Ã“","Ã”","ï£¿","Ã’","Ãš","Â»","Â«","Ã‡","â—Š","Ã‚","Â¿","â€¼","â–‘","â–’","â–“"],X={wall:{character:"#",diffuse:H[3],blocking:!0,lightBlocking:!0,description:"a wall"},corridor:{character:".",diffuse:H[0],blocking:!1,lightBlocking:!1,description:"a corridor"},room:{character:".",diffuse:U[1],blocking:!1,lightBlocking:!1,description:"floor of a room"},locker:{character:j[16],diffuse:U[1],blocking:!0,lightBlocking:!0,description:"a locker"},trash:{character:j[21],diffuse:H[2],blocking:!1,lightBlocking:!1,description:"some trash"},door:{character:j[27],diffuse:U[1],blocking:!0,lightBlocking:!0,description:"a door"},hub:{character:".",diffuse:U[0],blocking:!1,lightBlocking:!1,description:"floor of a hub"},player:{character:"@",diffuse:U[0],blocking:!0,lightBlocking:!0,description:"you"},guard:(q="g",G="a guard",{character:q,diffuse:U[1],blocking:!0,lightBlocking:!0,description:G}),eliteGuard:function(t,e){return{character:t,diffuse:U[3],blocking:!0,lightBlocking:!0,description:e}}("g","a very strong guard")};var q,G;function $(t,e,i,s){if(void 0!==e.getTile(i))throw new Error(`there is already a tile at ${i.key}`);const n=t.createEntity().withComponent("position",{position:i}).withComponent("feature",{type:s}).entity;return e.setTile(i,n),n}function Y(t){switch(t){case"up":return"left";case"right":return"up";case"down":return"right";case"left":return"down"}}function W(t){switch(t){case"up":return"right";case"right":return"down";case"down":return"left";case"left":return"up"}}function J(t){switch(t){case"up":return"down";case"right":return"left";case"down":return"up";case"left":return"right"}}class Q{contains(t){return t.all(t=>this.containsVector(t))}equals(t){return this.contains(t)&&t.contains(this)}foreach(t){this.all(e=>(t(e),!0))}some(t){return!this.all(e=>!t(e))}}class Z extends Q{constructor(t,e,i,s){super(),this.x=t,this.y=e,this.width=i,this.height=s}static fromBounds(t,e,i,s){return new Z(t,i,e-t+1,s-i+1)}static centerAt(t,e,i){return new Z(t-i,e-i,2*i+1,2*i+1)}get left(){return this.x}get right(){return this.x+this.width-1}get top(){return this.y}get bottom(){return this.y+this.height-1}get topLeft(){return new d(this.left,this.top)}get topRight(){return new d(this.right,this.top)}get bottomRight(){return new d(this.right,this.bottom)}get bottomLeft(){return new d(this.left,this.bottom)}get center(){const t=(this.left+this.right)/2,e=(this.top+this.bottom)/2;return new d(Math.floor(t),Math.floor(e))}get centerLeft(){const t=(this.top+this.bottom)/2;return new d(this.left,Math.floor(t))}get centerRight(){const t=(this.top+this.bottom)/2;return new d(this.right,Math.floor(t))}get centerTop(){const t=(this.left+this.right)/2;return new d(Math.floor(t),this.top)}get centerBottom(){const t=(this.left+this.right)/2;return new d(Math.floor(t),this.bottom)}plus(t){return Z.fromBounds(Math.min(this.left,t.left),Math.max(this.right,t.right),Math.min(this.top,t.top),Math.max(this.bottom,t.bottom))}cover(t){return Z.fromBounds(Math.min(this.left,t.x),Math.max(this.right,t.x),Math.min(this.top,t.y),Math.max(this.bottom,t.y))}bounds(){return this}containsVector(t){return t.x>=this.x&&t.x<this.x+this.width&&t.y>=this.y&&t.y<this.y+this.height}translate(t){return new Z(this.x+t.x,this.y+t.y,this.width,this.height)}grow(t=1){return new Z(this.x-t,this.y-t,this.width+2*t,this.height+2*t)}shrink(t=1){const e=this.width-2*t,i=this.height-2*t;return new Z(e>0?this.x+t:this.x,i>0?this.y+t:this.y,e>0?e:0,i>0?i:0)}all(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){if(!t(new d(i+this.x,e+this.y)))return!1}return!0}}class tt extends Q{constructor(t,e){super(),this.f=t,this.boundary=e}static lN(t,e=1,i=!1){return tt.fromMeasure(t,e,i,t=>t.lN()<=e)}static l1(t,e=1,i=!1){return tt.fromMeasure(t,e,i,t=>t.l1()<=e)}static l2(t,e=1,i=!1){return tt.fromMeasure(t,e,i,t=>t.squaredLength()<=e*e)}static fromMeasure(t,e,i,s){const n=Z.centerAt(t.x,t.y,e);return new tt(e=>{const n=e.minus(t).abs(),o=n.floor();return 0===o.x&&0===o.y?i:s(n)},n)}bounds(){return this.boundary}containsVector(t){return this.f(t)}translate(t){return new tt(e=>this.f(e.add(t)),this.boundary.translate(t))}grow(){return this}shrink(){return this}all(t){return this.boundary.all(e=>!this.f(e)||t(e))}}class et extends Q{constructor(t,e){super(),this.shape1=t,this.shape2=e}bounds(){return this.shape1.bounds().plus(this.shape2.bounds())}containsVector(t){return this.shape1.containsVector(t)||this.shape2.containsVector(t)}grow(t=1){return new et(this.shape1.grow(t),this.shape2.grow(t))}shrink(t=1){return new et(this.shape1.shrink(t),this.shape2.shrink(t))}translate(t){return new et(this.shape1.translate(t),this.shape2.translate(t))}all(t){return this.bounds().all(e=>!this.containsVector(e)||t(e))}}const it={shape:new Z(0,0,7,7),entries:[],assets:[],availableEntries:[{position:new d(3,-1),direction:"down",width:3},{position:new d(-1,3),direction:"right",width:3},{position:new d(7,3),direction:"left",width:3},{position:new d(4,7),direction:"up",width:3}],availableAssets:[]},st={shape:new Z(0,0,14,14),entries:[],assets:[],availableEntries:[{position:new d(3,-1),direction:"down",width:3},{position:new d(7,-1),direction:"down",width:3},{position:new d(11,-1),direction:"down",width:3},{position:new d(-1,3),direction:"right",width:3},{position:new d(14,3),direction:"left",width:3},{position:new d(-1,7),direction:"right",width:3},{position:new d(14,7),direction:"left",width:3},{position:new d(-1,11),direction:"right",width:3},{position:new d(14,11),direction:"left",width:3},{position:new d(3,14),direction:"up",width:3},{position:new d(7,14),direction:"up",width:3},{position:new d(11,14),direction:"up",width:3}],availableAssets:[]},nt={shape:new et(new Z(0,0,14,7),new Z(0,7,7,7)),entries:[],assets:[],availableEntries:[{position:new d(3,-1),direction:"down",width:3},{position:new d(7,-1),direction:"down",width:3},{position:new d(11,-1),direction:"down",width:3},{position:new d(-1,3),direction:"right",width:3},{position:new d(14,3),direction:"left",width:3},{position:new d(-1,7),direction:"right",width:3},{position:new d(11,7),direction:"up",width:3},{position:new d(-1,11),direction:"right",width:3},{position:new d(7,6),direction:"left",width:3},{position:new d(3,14),direction:"up",width:3}],availableAssets:[{position:new d(0,0)},{position:new d(5,5)},{position:new d(7,4)}]};function ot(t,e){t[e]=t[t.length-1],t.pop()}class rt{constructor(t){this.random=t}generate(t,e){const i=this.random.pick([it,st,nt]),s=function(t,e){const i=[];return t.forEach((t,s)=>{e(t)&&i.push(s)}),i}(i.availableEntries,t=>t.direction===e),n=this.random.pick(s),o=t.center.minus(i.availableEntries[n].position),r=i.shape.translate(o),a=[t],h=[],c=[];return i.availableEntries.forEach((t,e)=>{e!==n&&c.push({position:t.position.add(o),direction:t.direction,width:3})}),i.availableAssets.forEach(t=>{h.push({position:t.position.add(o)})}),{shape:r,assets:[],entries:a,availableEntries:c,availableAssets:h}}}function at(t,e,i){const s=ct(t,"door");return i.foreach(i=>{lt(t,e,i,s,"door")}),s}function ht(t,e,i,s){switch(s){case"door":return at(t,e,new Z(i.x,i.y,1,1));case"locker":return function(t,e,i){const s=ct(t,"locker");return lt(t,e,i,s,"locker"),s}(t,e,i);case"trash":return function(t,e,i){const s=ct(t,"trash");return lt(t,e,i,s,"trash"),s}(t,e,i)}}function ct(t,e){return t.createEntity().withComponent("asset",{type:e}).withComponent("trigger",{}).withComponent("children",{children:[]}).entity}function lt(t,e,i,s,n){const o=function(t,e,i){const s=e.removeTile(i);if(void 0===s)throw new Error(`cannot build asset on missing ground at ${i.key}`);const n=t.getComponent(s,"feature");if(void 0===n||X[n.type].blocking)throw new Error("cannot build asset on missing or blocking ground");return t.deleteEntity(s),n.type}(t,e,i),r=t.createEntity().withComponent("parent",{entity:s}).withComponent("position",{position:i}).withComponent("feature",{type:n}).withComponent("ground",{feature:o}).entity;e.setTile(i,r),t.getComponent(s,"children").children.push(r)}function ut(t){return{type:t,current:Object.assign({},dt[t])}}const dt={player:{health:10,energy:4,movement:6,actions:5,defense:4,aim:10},guard:{health:7,energy:4,movement:6,actions:3,defense:3,aim:10},eliteGuard:{health:10,energy:4,movement:4,actions:5,defense:5,aim:10}};function pt(t){return t.current.movement/42}class gt{constructor(t,e=40,i=3){this.random=t,this.maximumAge=e,this.maximumGenerations=i,this.components=["agent"],this.roomGenerator=new rt(t)}update(t,e){const i=t.getComponent(e,"agent"),s=t.getComponent(e,"position"),n=void 0!==i.allowedRegion?t.getComponent(i.allowedRegion,"region"):void 0;this.run(t,e,{position:s,agent:i,region:n})}run(t,e,i){const s=this.createAction(t,i);this.takeAction(t,e,i,s)}createAction(t,e){let i=0;for(let t=e.agent.actions.length-1;t>=0;t--){const s=e.agent.actions[t];if("move"===s)i++;else if("changeDirection"===s)break}let s=0;for(const t of e.agent.actions)"move"===t&&s++;if(s>this.maximumAge)return"close";const n=this.footprint(e.position.position,e.agent.direction,e.agent.width),o=t.getResource("map");if(o.isShapeFree(t,n))return"render";const r=this.freeCells(t,o,e,e.position.position,e.agent.direction,e.agent.width);if(i>e.agent.width&&r<2)return"changeDirection";if(this.random.decision(.3))return"createRoom";const a=e.position.position.add(d.fromDirection(e.agent.direction)),h=this.footprint(a,e.agent.direction,e.agent.width);return o.isShapeFree(t,h)?"move":"close"}takeAction(t,e,i,s){switch(i.agent.actions.push(s),s){case"render":this.render(t,i);break;case"changeDirection":{const{position:s,direction:n}=this.changeDirection(t,i);t.editEntity(e).withComponent("agent",Object.assign({},i.agent,{direction:n})).withComponent("position",{position:s});break}case"move":{const s=this.move(i);t.editEntity(e).withComponent("position",{position:s});break}case"createRoom":this.createRoom(t,i);break;case"close":t.deleteEntity(e)}}render(t,e){const i=t.getResource("map");this.footprint(e.position.position,e.agent.direction,e.agent.width).foreach(e=>$(t,i,e,"corridor"));let s=0;for(const t of e.agent.actions)"move"===t&&s++;s%10==0&&this.spawnLight(t,i,e.position.position)}createRoom(t,e){const i=t.getResource("map"),s=e.agent.direction,n=e.agent.width,o=this.footprint(e.position.position,s,n),r=this.random.decision(.5),a=r?Y(s):W(s);let h=r?this.leftPosition(s,o):this.rightPosition(s,o);const c=this.random.integerBetween(1,3),l=this.stepBack(e,c);h=h.add(l).add(d.fromDirection(a));const u=this.footprint(h,a,c),p=this.roomGenerator.generate(u,a);this.isInRegion(e,p.shape)&&i.isShapeFree(t,p.shape.grow())&&this.buildRoom(t,e,i,p)}buildRoom(t,e,i,s){s.shape.foreach(e=>$(t,i,e,"room")),this.spawnLight(t,i,s.shape.bounds().center),this.spawnEnemy(t,i,this.random.insideRectangle(s.shape.bounds()));let n=this.random.integerBetween(0,2);for(;n-- >0&&s.availableEntries.length>0;){const n=this.random.integerBetween(0,s.availableEntries.length-1),o=s.availableEntries[n],r=J(o.direction),a=this.random.integerBetween(1,3),h=this.footprint(o.position,r,a+2);i.isShapeFree(t,h)&&(ot(s.availableEntries,n),s.entries.push(this.footprint(o.position,r,a)),e.agent.generation<this.maximumGenerations&&this.spawnAgent(t,o.position,a,r,e.agent.generation+1,e.agent.allowedRegion))}s.entries.forEach(e=>{e.foreach(e=>$(t,i,e,"corridor")),at(t,i,e)});let o=this.random.integerBetween(1,2);for(;o-- >0&&s.availableAssets.length>0;){const e=this.random.integerBetween(0,s.availableAssets.length-1),n=s.availableAssets[e],o=[];i.shapeHasSome(t,tt.lN(n.position),t=>void 0===t||"wall"===t.type)&&o.push("locker"),o.push("trash");const r=this.random.pick(o);ot(s.availableAssets,e),ht(t,i,n.position,r)}}move(t){return t.position.position.add(d.fromDirection(t.agent.direction))}changeDirection(t,e){const i=t.getResource("map"),s=e.agent.direction,n=e.agent.width,o=this.footprint(e.position.position,s,n),r=this.freeCells(t,i,e,e.position.position,s,n);let a=this.leftPosition(s,o),h=this.rightPosition(s,o);const c=this.stepBack(e,n);h=h.add(c),a=a.add(c);const l=Y(s),u=this.freeCells(t,i,e,a,l,n),d=W(s),p=this.freeCells(t,i,e,h,d,n);let g=s,f=e.position.position;return r<=Math.max(u,p)&&(p<u?(g=l,f=a):(g=d,f=h)),{position:f,direction:g}}leftPosition(t,e){return"down"===t||"left"===t?e.bottomRight:e.topLeft}rightPosition(t,e){return"down"===t||"left"===t?e.topLeft:e.bottomRight}stepBack(t,e){const i=t.agent.direction;let s=Math.floor(e/2);return e%2!=0||"down"!==i&&"right"!==i||s--,d.fromDirection(i).mult(-s)}freeCells(t,e,i,s,n,o,r=10){const a=d.fromDirection(n);let h=0,c=s.add(a),l=this.footprint(c,n,o+2);for(;this.isInRegion(i,l)&&e.isShapeFree(t,l)&&(h++,c=c.add(a),l=this.footprint(c,n,o+2),!(h>=r)););return h}footprint(t,e,i){const s=d.fromDirection(e).perpendicular().abs(),n=Math.floor(i/2),o=t.add(s.mult(-n)),r=o.add(s.mult(i-1));return Z.fromBounds(o.x,r.x,o.y,r.y)}isInRegion(t,e){return void 0===t.region||t.region.shape.contains(e)}spawnAgent(t,e,i,s,n,o){t.createEntity().withComponent("agent",{actions:[],direction:s,width:i,generation:n,allowedRegion:o}).withComponent("position",{position:e})}spawnEnemy(t,e,i){const s=this.random.pick(["guard","eliteGuard"]),n=new d(i.x,i.y).center,o=t.createEntity().withComponent("npc",{}).withComponent("feature",{type:s}).withComponent("position",{position:n}).withComponent("fov",{fov:[]}).withComponent("character-stats",ut(s)).entity;e.setCharacter(i,o)}spawnLight(t,e,i){const s=t.createEntity().withComponent("light",{color:new I([this.random.integerBetween(0,255),this.random.integerBetween(0,255),this.random.integerBetween(0,255)])}).withComponent("position",{position:i}).withComponent("active",{}).entity;e.addLight(i,s)}}class ft{constructor(t){this.queries=t,this.components=["fov","position"]}update(t,e){const i=t.getComponent(e,"fov"),s=t.getComponent(e,"position");i.fov=[],this.queries.fov(t,s.position.floor(),(t,e)=>i.fov.push({position:t,distance:e}))}}class mt{constructor(){this.components=["free-mode-anchor","position"]}update(t,e){const i=t.getComponent(e,"position"),s=t.getResource("input").createMovementDelta();if(s.squaredLength()>0){const n=i.position.add(s);t.editEntity(e).withComponent("position",{position:n})}}}class wt{constructor(t){this.queries=t,this.components=["active","light","position"]}update(t,e){const i=t.getComponent(e,"light"),s=t.getComponent(e,"position"),n=t.getResource("map");this.queries.lighting(t,s.position.floor(),i.color,(i,s)=>{const o=n.getTile(i);void 0!==o&&this.addLight(t,o,e,s);const r=n.getCharacter(i);void 0!==r&&this.addLight(t,r,e,s)})}addLight(t,e,i,s){const n=t.getComponent(e,"lighting")||{incomingLight:new Map};n.incomingLight.set(i,s),t.editEntity(e).withComponent("lighting",n)}}class _t{constructor(t){this.usedSystems=t}start(t){this.usedSystems.forEach(e=>t.enableSystem(e))}stop(t){this.usedSystems.forEach(e=>t.disableSystem(e))}isDone(t){return void 0===this.usedSystems.find(e=>!t.emptySystems.has(e))}}class yt extends _t{constructor(){super(["fov","light","player-round-control","script","damage"]),this.wasGridLocked=!0}start(t){super.start(t),this.addCharactersToRound(t),this.setStartingEntity(t);const e=t.getResource("viewport");this.wasGridLocked=e.gridLocked,e.gridLocked=!0}stop(t){t.getResource("viewport").gridLocked=this.wasGridLocked}addCharactersToRound(t){t.components.get("character-stats").foreach(e=>{t.editEntity(e).withComponent("wait-turn",{})})}setStartingEntity(t){let e;t.components.get("player").foreach(t=>e=t);const i=t.getComponent(e,"character-stats");t.editEntity(e).withComponent("take-turn",{movements:i.current.movement,actions:i.current.actions}).removeComponent("wait-turn")}isFrameLocked(){return!0}}class vt{constructor(t){this.pushState=t,this.components=["npc","fov"]}update(t,e){const i=t.getComponent(e,"fov");t.components.get("player").foreach(e=>{const s=t.getComponent(e,"position");if(void 0!==s){const t=s.position.floor().key;i.fov.forEach(e=>{t===e.position.floor().key&&this.pushState(new yt)})}})}}class bt{constructor(){this.components=["player","position","character-stats"]}update(t,e){const i=t.getComponent(e,"position"),s=t.getComponent(e,"character-stats"),n=t.getResource("input").createMovementDelta();if(n.squaredLength()>0){const o=i.position.add(n.mult(pt(s))),r=t.getResource("map");r.isBlocking(t,o.floor(),e)||(r.removeCharacter(i.position.floor()),r.setCharacter(o.floor(),e),t.editEntity(e).withComponent("position",{position:o}))}}}class kt{constructor(){this.components=["player","position"]}update(t,e){if(t.getResource("input").keyPressed.has(T.VK_E)){const i=t.getResource("map"),s=t.getComponent(e,"position"),n=tt.lN(s.position.floor(),1,!0),o=this.findTrigger(t,i,n);void 0!==o&&t.editEntity(o).withComponent("active",{})}}findTrigger(t,e,i){let s;return i.some(i=>{const n=e.getTile(i);if(void 0!==n){if(void 0!==t.getComponent(n,"trigger"))return s=n,!0;const e=t.getComponent(n,"parent");if(void 0!==e&&void 0!==t.getComponent(e.entity,"trigger"))return s=e.entity,!0}return!1}),s}}const Ct={shape:new Z(0,0,7,7),entries:[{position:new d(3,-1),direction:"up",width:3},{position:new d(-1,3),direction:"left",width:3},{position:new d(7,3),direction:"right",width:3},{position:new d(4,7),direction:"down",width:3}],assets:[]};class St{constructor(t){this.random=t}generate(t){const e=this.random.pick([Ct]),i=e.shape.bounds(),s=t.minus(i.center);return{entries:e.entries.map(t=>({direction:t.direction,position:t.position.add(s),width:3})),assets:e.assets.map(t=>({position:t.position.add(s)})),shape:e.shape.translate(s)}}}class Et{constructor(t){this.random=t,this.components=["active","region"],this.landmarkGenerator=new St(t)}update(t,e){const i=t.getComponent(e,"region"),s=this.buildLeftLandmark(t,e,i),n=this.buildCentralLandmark(t,e,i);i.landmarks=[n,s],t.editEntity(e).removeComponent("active")}buildCentralLandmark(t,e,i){const s=this.landmarkGenerator.generate(i.shape.bounds().center);return s.entries.forEach(i=>this.spawnAgent(t,i,e)),this.renderLandmark(t,s),s}buildLeftLandmark(t,e,i){const s=i.shape.bounds(),n=this.createRegion(t,Z.fromBounds(s.right,s.right+s.width,s.top+s.width/4,s.bottom-s.width/4)),o=this.landmarkGenerator.generate(s.centerRight);return o.entries=o.entries.filter(t=>"left"===t.direction||"right"===t.direction),o.entries.forEach(i=>{const s="left"===i.direction?e:n;this.spawnAgent(t,i,s)}),this.renderLandmark(t,o),o}createRegion(t,e){return t.createEntity().withComponent("region",{shape:e,landmarks:[]}).entity}spawnAgent(t,e,i){t.createEntity().withComponent("agent",{actions:[],direction:e.direction,width:e.width,generation:0,allowedRegion:i}).withComponent("position",{position:e.position}).withComponent("active",{})}renderLandmark(t,e){const i=t.getResource("map");e.shape.foreach(e=>$(t,i,e,"hub"))}}class xt{constructor(t){this.queries=t,this.components=["take-turn","player","position"]}update(t,e){const i=t.getResource("map"),s=t.getResource("viewport"),n=t.getResource("input"),o=t.getComponent(e,"script"),r=t.getComponent(e,"selected-action"),a=t.getComponent(e,"take-turn");if(void 0===o){const o=t.getResource("ui");if(void 0===r)this.showActionSelection(t,o,e,a);else if(void 0===r.type)this.selectActionType(t,o,r);else if("move"===r.type){const o=this.selectMovementPath(t,n,s,i,e,a);void 0!==o&&(a.movements-=o.cost,t.editEntity(e).withComponent("script",{actions:o.path.map(t=>({type:"move",position:t}))}).removeComponent("selected-action"))}else if("use"===r.type){const o=t.getComponent(e,"take-turn"),a=0===r.using?1:5,h=this.selectAttackPath(t,n,s,i,e,a);void 0!==h&&(o.actions-=1,h.path.some(s=>{const n=i.getCharacter(s),o=void 0!==n&&n!==e;return o&&t.createEntity().withComponent("damage",{source:e,target:n,damage:0===r.using?10:7}),o}),t.editEntity(e).removeComponent("selected-action"))}}}showActionSelection(t,e,i,s){const n=[];s.movements>0&&n.push("move"),s.actions>1&&(n.push("melee"),n.push("nail gun")),e.showSelectList(t,n),t.editEntity(i).withComponent("selected-action",{})}selectActionType(t,e,i){const s=e.selectListSelection();if(s){switch(s){case"move":i.type="move";break;case"melee":i.type="use",i.using=0;break;case"nail gun":i.type="use",i.using=1}e.hideSelectList(t)}}selectMovementPath(t,e,i,s,n,o){if(void 0!==e.position){const r=i.fromDisplay(e.position),a=t.getComponent(n,"position"),h=this.queries.shortestPath(t,a.position,r,{maximumCost:o.movements,onlyDiscovered:!0});if(void 0!==h&&(h.path.forEach(e=>{const i=s.getTile(e);t.editEntity(i).withComponent("overlay",{background:U[2]})}),e.mousePressed))return h}}selectAttackPath(t,e,i,s,n,o){if(void 0!==e.position){const r=i.fromDisplay(e.position),a=t.getComponent(n,"position"),h=this.queries.ray(t,a.position,r,{maximumCost:o});if(void 0!==h&&(h.path.forEach(e=>{const i=s.getCharacter(e);if(void 0!==i&&i!==n)t.editEntity(i).withComponent("overlay",{background:U[3]});else{const i=s.getTile(e);t.editEntity(i).withComponent("overlay",{background:U[1]})}}),e.mousePressed))return h}}}class Vt{constructor(){this.components=["active","trigger"]}update(t,e){const i=t.getComponent(e,"asset");if(void 0!==i)switch(i.type){case"door":this.door(t,e)}t.editEntity(e).removeComponent("active")}door(t,e){t.getComponent(e,"children").children.forEach(e=>this.swapGroundAndFeature(t,e))}swapGroundAndFeature(t,e){const i=t.getComponent(e,"feature"),s=t.getComponent(e,"ground"),n=i.type;i.type=s.feature,s.feature=n}}class Mt{constructor(){this.components=["damage"]}update(t,e){const i=t.getComponent(e,"damage"),s=t.getComponent(i.target,"character-stats");console.log(`${i.source} hits ${i.target} with ${i.damage} damage`);const n=Math.max(0,i.damage-s.current.defense);s.current.health-=n,console.log(`${i.target} suffers ${n} damage, his health is down to ${s.current.health}`),s.current.health<=0&&t.deleteEntity(i.target),t.deleteEntity(e)}}class Kt{constructor(t,e){this.origin=t,this.direction=e}side(t){const e=(t.x-this.origin.x)*this.direction.y-(t.y-this.origin.y)*this.direction.x;return e<0?"left":0===e?"inside":"right"}}class Lt{constructor(){this.components=["script"]}update(t,e){const i=t.getComponent(e,"script"),s=i.actions.pop();if(void 0===s)t.editEntity(e).removeComponent("script");else{let n=!0;switch(s.type){case"move":n=this.move(t,e,s.position);break;default:console.error(`${s.type} is not a known action type`)}n||i.actions.push(s)}}move(t,e,i){const s=t.getComponent(e,"character-stats"),n=t.getComponent(e,"position"),o=i.center.minus(n.position).normalize();if(o.isNan())return console.warn("target already reached"),!0;const r=o.mult(pt(s));let a=n.position.add(r);const h=new Kt(i.center,o.perpendicular());let c=!1;h.side(n.position)!==h.side(a)&&(a=i.center,c=!0);const l=t.getResource("map");return l.removeCharacter(a.floor()),l.setCharacter(n.position.floor(),e),n.position=a,c}}class Tt{constructor(){this.objects=new Set}has(t){return this.objects.has(t.key)}set(t){this.objects.add(t.key)}setAll(t){t.foreach(t=>this.set(t))}remove(t){const e=t.key,i=this.objects.has(e);return this.objects.delete(e),i}}class Rt{constructor(){this.kind="map",this.tiles=new l,this.characters=new l,this.boundaries=new Z(0,0,0,0),this.visible=new Tt,this.discovered=new Tt,this.lights=new u}update(t){this.visible=new Tt;const e=new Set;t.components.get("player").foreach(i=>{const s=t.getComponent(i,"fov");void 0!==s&&s.fov.forEach(t=>{this.visible.set(t.position),this.discovered.set(t.position),this.lights.get(t.position).forEach(t=>e.add(t))})}),t.components.get("light").foreach(i=>{const s=t.editEntity(i);e.has(i)?s.withComponent("active",{}):s.removeComponent("active")})}setTile(t,e){this.tiles.set(t,e),this.boundaries=this.boundaries.cover(t)}getTile(t){return this.tiles.get(t)}removeTile(t){return this.tiles.remove(t)}setCharacter(t,e){this.characters.set(t,e),this.boundaries=this.boundaries.cover(t)}getCharacter(t){return this.characters.get(t)}removeCharacter(t){return this.characters.remove(t)}addLight(t,e){this.lights.addAll(tt.l2(t,6,!0),e)}isDiscovered(t){return this.discovered.has(t)}isVisible(t){return this.visible.has(t)}isBlocking(t,e,i){return this.tileMatches(t,e,t=>void 0===t||X[t.type].blocking)||this.characterMatches(t,e,t=>void 0!==t&&X[t.type].blocking,i)}isLightBlocking(t,e,i=!0){return this.tileMatches(t,e,t=>void 0===t||X[t.type].lightBlocking)||i&&this.characterMatches(t,e,t=>void 0!==t&&X[t.type].lightBlocking)}tileMatches(t,e,i){return this.featureMatches(t,this.tiles.get(e),i)}characterMatches(t,e,i,s){const n=this.characters.get(e);return(void 0===n||void 0===s||s!==n)&&this.featureMatches(t,n,i)}featureMatches(t,e,i){let s;return void 0!==e&&(s=t.getComponent(e,"feature")),i(s)}isShapeFree(t,e){return this.shapeHasAll(t,e,t=>void 0===t)}isShapeBlocked(t,e){return this.shapeHasSome(t,e,t=>void 0!==t)}shapeHasAll(t,e,i){return e.all(e=>this.tileMatches(t,e,i))}shapeHasSome(t,e,i){return e.some(e=>this.tileMatches(t,e,i))}}class At{constructor(t=new d(60,40)){this.boundaries=t,this.kind="viewport",this.gridLocked=!1,this.topLeft=new d(0,0),this.layers=[]}update(t){t.getResource("input").keyPressed.has(T.VK_G)&&(this.gridLocked=!this.gridLocked),t.components.get("viewport-focus").foreach(e=>{const i=t.getComponent(e,"position");this.focus(i.position)})}collectRenderables(t){const e=[];for(let i=0;i<this.boundaries.y;i++)for(let s=0;s<this.boundaries.x;s++){const n=this.fromDisplay({x:s,y:i});for(let o=this.layers.length-1;o>=0;o--){const r=this.layers[o];let a;if(void 0!==(a=r.transformed?r.getRenderable(t,n):r.getRenderable(t,new d(s,i))).entity&&e.push(a),!a.opaque)break}}return e.reverse()}addLayer(t){this.layers.push(t)}fromDisplay(t){return this.topLeft.add(new d(t.x,t.y))}toDisplay(t,e){const i={x:t.x-this.topLeft.x,y:t.y-this.topLeft.y};return this.gridLocked&&(i.x=Math.floor(i.x),i.y=Math.floor(i.y)),!this.gridLocked&&e&&(i.x-=.5,i.y-=.25),i}focus(t){const e=t.x-Math.floor(this.boundaries.x/2),i=t.y-Math.floor(this.boundaries.y/2);this.gridLocked?this.topLeft=new d(Math.floor(e),Math.floor(i)):this.topLeft=new d(e,i)}}class Ot{constructor(t){this.distribution=t}floatBetween(t,e){return this.distribution.sample()*(e-t)+t}integerBetween(t,e){const i=this.distribution.sample();return Math.floor(i*(e-t+1))+t}decision(t){return this.distribution.sample()<t}weightedDecision(t){const e=t.reduce((t,e)=>t+e,0),i=this.integerBetween(0,e-1);let s=0;for(let e=0;e<t.length;e++)if(i<(s+=t[e]))return e;throw new Error("invalid input to weighted decision")}pick(t){return t[this.integerBetween(0,t.length-1)]}shuffle(t){for(let e=t.length-1;e>=0;e--){const i=this.integerBetween(0,e),s=t[e];t[e]=t[i],t[i]=s}}insideRectangle(t){return new d(this.integerBetween(t.left,t.right),this.integerBetween(t.top,t.bottom))}}var Pt=i(5);class Dt{constructor(t){this.rng=Object(Pt.create)(t)}sample(){return this.rng.random()}}class Nt{constructor(t){this.eventToPosition=t,this.kind="input",this.position=void 0,this.mouseDown=!1,this.mousePressed=!1,this.mouseReleased=!1,this.keyDown=new Set,this.keyPressed=new Set,this.keyReleased=new Set,this.mouseEvent=void 0,this.keyEvents=[],document.addEventListener("mousedown",t=>this.mouseEvent=t),document.addEventListener("mousemove",t=>this.mouseEvent=t),document.addEventListener("keydown",t=>this.keyEvents.push(t)),document.addEventListener("keyup",t=>this.keyEvents.push(t))}update(){this.handleMouseEvent(),this.handleKeyboardEvents()}createMovementDelta(){let t=new d(0,0);return this.keyDown.has(T.VK_H)&&(t=t.add(d.fromDirection("left"))),this.keyDown.has(T.VK_J)&&(t=t.add(d.fromDirection("down"))),this.keyDown.has(T.VK_K)&&(t=t.add(d.fromDirection("up"))),this.keyDown.has(T.VK_L)&&(t=t.add(d.fromDirection("right"))),t.normalize()}handleMouseEvent(){if(this.mouseReleased=!1,this.mousePressed=!1,this.mouseEvent){this.position=this.eventToPosition(this.mouseEvent),this.mouseEvent.buttons>0?this.position&&(this.mousePressed=!0,this.mouseDown=!0):(this.mouseDown=!1,this.mouseReleased=!0),this.mouseEvent=void 0}}handleKeyboardEvents(){this.keyPressed.clear(),this.keyReleased.clear();for(const t of this.keyEvents)"keydown"===t.type?(this.keyPressed.add(t.keyCode),this.keyDown.add(t.keyCode)):(this.keyReleased.add(t.keyCode),this.keyDown.delete(t.keyCode));this.keyEvents=[]}}class Bt extends Q{constructor(t,e){super(),this.baseShape=t,this.subtractionShape=e}static innerBorder(t){return new Bt(t,t.shrink())}bounds(){return this.baseShape.bounds()}containsVector(t){return this.baseShape.containsVector(t)&&!this.subtractionShape.containsVector(t)}grow(t=1){return new Bt(this.baseShape.grow(t),this.subtractionShape.grow(t))}shrink(t=1){return new Bt(this.baseShape.shrink(t),this.subtractionShape.shrink(t))}translate(t){return new Bt(this.baseShape.translate(t),this.subtractionShape.translate(t))}all(t){return this.bounds().all(e=>!this.containsVector(e)||t(e))}}class Ft{constructor(){this.kind="ui",this.visibleElements=[],this.selectList=void 0}update(t){const e=t.getResource("input");let i;e.position&&(i=new d(e.position.x,e.position.y)),this.updateSelectList(i,e.mousePressed)}updateSelectList(t,e){if(void 0!==this.selectList){this.selectList.hovered=void 0,this.selectList.selected=void 0;const i=this.selectList.shape.shrink();if(t&&i.containsVector(t)){const s=t.minus(i.topLeft);this.selectList.hovered=s.y,e&&(this.selectList.selected=s.y)}}}render(t){this.renderInfoPopup(t)}renderInfoPopup(t){if(void 0!==this.selectList){const e=this.selectList;Bt.innerBorder(e.shape).foreach(e=>{t.character("+",e,U[0])}),e.entries.forEach((i,s)=>{t.text(i,e.shape.topLeft.add(new d(1,s+1)),U[0],e.hovered===s?H[1]:void 0)})}}showSelectList(t,e){const i=t.getResource("viewport"),s=e.length+2;let n;n=void 0!==this.selectList?this.selectList.element:t.createEntity().entity;const o=new Z(30,i.boundaries.y-s,20,s);this.selectList={entries:e,shape:o,element:n,hovered:void 0,selected:void 0}}hideSelectList(t){void 0!==this.selectList&&(t.deleteEntity(this.selectList.element),this.selectList=void 0)}selectListSelection(){if(void 0!==this.selectList&&void 0!==this.selectList.selected)return this.selectList.entries[this.selectList.selected]}hasElement(t){return void 0!==this.selectList&&this.selectList.shape.containsVector(t)}}class zt extends _t{constructor(){super(["fov","light","player-control","player-interaction","npc","trigger","free-mode-control","damage"])}start(t){super.start(t);const e=t.components.get("spawn");if(1===e.size()){const i=t.getResource("map");e.foreach(e=>{const s=t.getComponent(e,"position").position,n=t.createEntity().withComponent("player",{}).withComponent("viewport-focus",{}).withComponent("position",{position:s}).withComponent("feature",{type:"player"}).withComponent("fov",{fov:[]}).withComponent("character-stats",ut("player")).entity;i.setCharacter(s,n),t.getResource("viewport").addLayer({getRenderable:(t,e)=>{const i=t.getResource("ui"),s=e.floor();return{entity:void 0,opaque:!i.hasElement(s),centered:!0}},transformed:!1})})}else{const e=new d(20,20);t.createEntity().withComponent("free-mode-anchor",{}).withComponent("viewport-focus",{}).withComponent("position",{position:e})}}isFrameLocked(){return!0}}class It extends _t{constructor(){super(["region-creator","agent"])}start(t){super.start(t);const e=t.getResource("viewport");e.addLayer({getRenderable:(t,e)=>{return{entity:t.getResource("map").getTile(e.floor()),opaque:!0,centered:!0}},transformed:!0}),e.addLayer({getRenderable:(t,e)=>{return{entity:t.getResource("map").getCharacter(e.floor()),opaque:!0,centered:!1}},transformed:!0}),this.startRegion=t.createEntity().withComponent("region",{shape:new Z(0,0,50,50),landmarks:[]}).withComponent("active",{}).entity}stop(t){if(super.stop(t),void 0!==this.startRegion){const e=t.getComponent(this.startRegion,"region").landmarks[0].shape.bounds().center;t.createEntity().withComponent("position",{position:e}).withComponent("spawn",{})}this.fillWalls(t)}isFrameLocked(){return!1}fillWalls(t){const e=t.getResource("map");e.boundaries.grow().foreach(i=>{void 0===e.getTile(i)&&e.isShapeBlocked(t,tt.lN(i,1))&&$(t,e,i,"wall")})}}class Ut{constructor(){const t={width:60,height:40,forceSquareRatio:!0,fontSize:17,fontFamily:"Lucida Console, Monaco, monospace",bg:H[4].rgb};this.ambientColor=new I([120,120,120]),this.display=new O(t),document.getElementById("tlb").appendChild(this.display.getContainer())}clear(){this.display.clear()}render(t){this.clear();const e=t.getResource("viewport");e.collectRenderables(t).forEach(({entity:i,centered:s})=>{void 0!==i&&this.renderEntity(t,e,i,s)}),t.getResource("ui").render(this),t.components.get("lighting").clear(),t.components.get("overlay").clear()}renderEntity(t,e,i,s){const n=function(t,e){const i=t.getComponent(e,"feature");if(i)return X[i.type]}(t,i),o=t.getComponent(i,"position");n&&o&&this.renderFeature(t,e,i,s,n,o)}renderFeature(t,e,i,s,n,o){const r=t.getResource("map"),a=o.position.floor();if(r.isDiscovered(a)){let h=void 0;r.isVisible(a)&&(h=t.getComponent(i,"lighting"));const c=t.getComponent(i,"overlay")||{background:void 0},l=e.toDisplay(o.position,s);this.character(n.character,l,this.computeColor(this.ambientColor,n.diffuse,h),c.background)}}computeColor(t,e,i){if(void 0===i)return e.multiply(t);{let s=t;return i.incomingLight.forEach(t=>{s=s.add(t)}),e.multiply(s)}}eventToPosition(t){const e=this.display.eventToPosition(t);if("object"==typeof e)return{x:e[0],y:e[1]}}character(t,e,i,s){const n=i.rgb,o=s?s.rgb:void 0;this.display.draw(e.x,e.y,t[0],n,o||null)}text(t,e,i,s){const n=i.rgb,o=s?s.rgb:void 0;for(let i=0;i<t.length;i++)this.display.draw(e.x+i,e.y,t[i],n,o||null)}}function Ht(t,e,i,s){e.foreach(e=>{const n=e.key;!t.has(n)&&s(e)&&(i.push(e),t.add(n))})}class jt{constructor(t){this.maximumKeySpan=t,this.bucketOfValue=new Map,this.buckets=[],this.boundaries=[],this.bucketCount=Math.floor(Math.log2(t+1))+1,this.boundaries[0]=0,this.buckets[0]=[],this.boundaries[1]=1,this.buckets[1]=[],this.boundaries[this.bucketCount+1]=t;for(let t=2;t<=this.bucketCount;t++)this.boundaries[t]=2<<t-2,this.buckets[t]=[]}insert(t,e){this.insertIntoLargestPossibleBucket(e,t,this.bucketCount)}getKey(t,e=((t,e)=>t===e)){let i=this.bucketOfValue.get(t);if(void 0!==i)return this.findInBucket(i,t,e)}decreaseKey(t,e,i=((t,e)=>t===e)){let s=this.bucketOfValue.get(t);if(void 0===s)throw Error(`unknown bucket for value ${t}`);this.removeFromBucket(t,s,i),this.insertIntoLargestPossibleBucket(e,t,s)}extractMin(){let t=this.buckets[0].pop();if(void 0===t){let e=1;for(;e<=this.bucketCount&&0===this.buckets[e].length;)e++;if(e>this.bucketCount)return;let i=Number.MAX_VALUE;const s=this.buckets[e];this.buckets[e]=[];for(let t=0;t<s.length;t++){const e=s[t];i>e.key&&(i=e.key),this.bucketOfValue.delete(e.value)}this.boundaries[0]=i,this.boundaries[1]=i+1;for(let t=2;t<=e;t++)this.boundaries[t]=Math.min(this.boundaries[t-1]+(2<<t-2),this.boundaries[e+1]);for(let t=0;t<s.length;t++){const i=s[t];this.insertIntoLargestPossibleBucket(i.key,i.value,e)}t=this.buckets[0].pop()}return this.bucketOfValue.delete(t.value),t.value}removeFromBucket(t,e,i){this.bucketOfValue.delete(t);const s=this.buckets[e],n=s.findIndex(e=>i(e.value,t));s[n]=s[s.length-1],s.pop()}insertIntoLargestPossibleBucket(t,e,i){for(;this.boundaries[i]>t;)--i;this.buckets[i].push({key:t,value:e}),this.bucketOfValue.set(e,i)}findInBucket(t,e,i){const s=this.buckets[t],n=s.findIndex(t=>i(t.value,e)),o=s[n];if(void 0!==o)return o.key}}function Xt(t,e,i,s,n,o){const r=function(t,e,i,s,n,o){const r=e.key,a=new Map,h=new Set,c=new jt(256),l=new Map;c.insert(t,n(t)),l.set(t.key,0),a.set(t.key,t);for(;;){const t=c.extractMin();if(void 0===t)break;const e=t.key,u=l.get(e);if(r===e)break;h.add(t.key),s(t).foreach(e=>{const s=e.key;if(!h.has(s)){const r=i(t,e);if(void 0!==r){const i=u+r,h=l.get(s)||Number.MAX_VALUE;if(i<h&&i<=o){a.set(s,t),l.set(s,i);const o=i+n(t);void 0===c.getKey(e)?c.insert(e,o):c.decreaseKey(e,o)}}}})}return{parent:a,costMap:l}}(t,e,i,s,n,o);return function(t,e,i){let s=[],n=t;for(;;){const t=n.key;s.push(n);const i=e.get(t);if(void 0===i)return;if(n.key===i.key)break;n=i}return{path:s,cost:i.get(t.key)}}(e,r.parent,r.costMap)}function qt(t,e,i=!1){let s={x:Math.abs(e.x),y:Math.abs(e.y)};const n=Math.sign(e.x),o=Math.sign(e.y);let r=!1;s.y>s.x&&(s={x:s.y,y:s.x},r=!0);let a=2*s.y-s.x,h=0;const c={x:t.x,y:t.y};let l=!1;return()=>{if(l)return;const t=new d(c.x,c.y);if(i||h<s.x){for(;a>0;)a-=2*s.x,r?c.x+=n:c.y+=o;a+=2*s.y,r?c.y+=o:c.x+=n}else l=!0;return h+=1,t}}class Gt extends Q{constructor(t,e){super(),this.from=t,this.to=e}get direction(){return this.to.minus(this.from)}bounds(){return new Z(Math.min(this.from.x,this.to.x),Math.min(this.from.y,this.to.y),Math.abs(this.from.x-this.to.x),Math.abs(this.from.y-this.to.y))}translate(t){return new Gt(this.from.add(t),this.to.add(t))}containsVector(t){return this.some(e=>t.equals(e))}grow(t=1){const e=qt(this.from,this.direction.mult(-1),!0),i=qt(this.to,this.direction,!0);let s=e(),n=i();for(let o=0;o<t;o++)s=e(),n=i();return new Gt(s,n)}shrink(t=1){const e=qt(this.from,this.direction,!0),i=qt(this.to,this.direction.mult(-1),!0);let s=e(),n=i();for(let o=0;o<t;o++)s=e(),n=i();return new Gt(s,n)}all(t){const e=qt(this.from,this.direction,!1);for(;;){const i=e();if(void 0===i)return!0;if(!t(i))return!1}}}class $t{fov(t,e,i){const s=t.getResource("map"),n=new N.RecursiveShadowcasting((e,i)=>!s.isLightBlocking(t,new d(e,i)),{topology:8}),o=new Set;n.compute(e.x,e.y,20,(t,e,s)=>{const n=new d(t,e),r=n.key;o.has(r)||(o.add(r),i(n,s))})}lighting(t,e,i,s){const n=t.getResource("map"),o=new N.RecursiveShadowcasting((e,i)=>!n.isLightBlocking(t,new d(e,i)),{topology:8}),r=new F((e,i)=>n.isLightBlocking(t,new d(e,i))?0:1,{passes:1});r.setLight(e.x,e.y,i.color),r.setFOV(o),r.setOptions({range:6}),r.compute((t,e,i)=>{s(new d(t,e),new I(i))})}explore(t,e,i,s){const n=t.getResource("map"),o=s.maximumCost||Number.MAX_SAFE_INTEGER,r=s.onlyDiscovered||!1;!function(t,e,i,s){const n=new Set([t.key]);let o=1,r=[],a=[];for(Ht(n,e(t),r,t=>s(t,o));;){const t=r.pop();if(void 0!==t)i(t,o),Ht(n,e(t),a,t=>s(t,o));else if(r=a,a=[],o++,0===r.length)break}}(e.floor(),t=>tt.lN(t,1,!1),i,(e,i)=>!(i>=o||n.isBlocking(t,e))&&(!r||n.isDiscovered(e)))}shortestPath(t,e,i,s){const n=t.getResource("map"),o=s.onlyDiscovered||!1,r=e.floor(),a=i.floor(),h=s.maximumCost||Number.MAX_SAFE_INTEGER,c=Xt(r,a,(e,i)=>{if(!n.isBlocking(t,i)&&(!o||n.isDiscovered(i)))return e.minus(i).l1()},t=>tt.lN(t,1,!1),t=>a.minus(t).lN(),h);if(void 0!==c&&c.path.length-1<=h)return{path:c.path.slice(0,c.path.length-1),cost:c.cost}}ray(t,e,i,s){const n=t.getResource("map"),o=e.floor(),r=i.floor(),a=s.maximumCost||Number.MAX_SAFE_INTEGER,h=[];if(new Gt(r,o).all(e=>(h.push(e),!n.isLightBlocking(t,e,!1)))){let t=h.length-1;if(h.length-1<=a)return{path:h.slice(0,h.length-1),cost:t}}}}const Yt=new class{constructor(t=new o,e=60){this.world=t,this.targetFps=e,this.computeTime=0,this.frames=0,this.renderTime=0,this.started=0,this.states=[],this.renderer=new Ut,this.rayCaster=new $t}init(){var t;(t=this.world).registerComponentStorage("active",new r),t.registerComponentStorage("age",new h),t.registerComponentStorage("agent",new h),t.registerComponentStorage("asset",new h),t.registerComponentStorage("character-stats",new h),t.registerComponentStorage("children",new h),t.registerComponentStorage("damage",new h),t.registerComponentStorage("feature",new c),t.registerComponentStorage("fov",new h),t.registerComponentStorage("free-mode-anchor",new a),t.registerComponentStorage("ground",new h),t.registerComponentStorage("light",new h),t.registerComponentStorage("lighting",new c),t.registerComponentStorage("npc",new r),t.registerComponentStorage("overlay",new h),t.registerComponentStorage("parent",new h),t.registerComponentStorage("player",new a),t.registerComponentStorage("position",new c),t.registerComponentStorage("region",new h),t.registerComponentStorage("script",new h),t.registerComponentStorage("selected-action",new a),t.registerComponentStorage("spawn",new a),t.registerComponentStorage("take-turn",new h),t.registerComponentStorage("took-turn",new r),t.registerComponentStorage("trigger",new r),t.registerComponentStorage("viewport-focus",new a),t.registerComponentStorage("wait-turn",new r),function(t,e){t.registerResource(new Rt),t.registerResource(new At),t.registerResource(new Nt(t=>e.eventToPosition(t))),t.registerResource(new Ft)}(this.world,this.renderer),function(t,e,i){const s=new Dt("some seed");t.registerSystem("agent",new gt(new Ot(s))),t.registerSystem("free-mode-control",new mt),t.registerSystem("light",new wt(e)),t.registerSystem("player-control",new bt),t.registerSystem("player-round-control",new xt(e)),t.registerSystem("player-interaction",new kt),t.registerSystem("fov",new ft(e)),t.registerSystem("npc",new vt(i)),t.registerSystem("region-creator",new Et(new Ot(s))),t.registerSystem("trigger",new Vt),t.registerSystem("script",new Lt),t.registerSystem("damage",new Mt)}(this.world,this.rayCaster,t=>this.pushState(t));const e=new zt,i=new It;this.states=[e,i]}execute(){this.enterState(),this.started=Date.now(),this.tick()}tick(){const t=this.states[this.states.length-1];let e=1e3/this.targetFps;const i=Date.now();this.world.updateResources(),this.renderer.render(this.world);const s=Date.now()-i;for(e-=s,this.renderTime+=s;;){const i=Date.now();this.world.updateSystems();const s=Date.now()-i;if(e-=s,this.computeTime+=s,t.isFrameLocked()||t.isDone(this.world)||e<s)break}if(t.isDone(this.world)){if(t.stop(this.world),this.states.pop(),0===this.states.length)return;this.enterState()}this.frames++,this.frames%100==0&&(console.log(`${this.mspf.toFixed(2)} ms per frame @${this.fps.toFixed(1)} FPS`),console.log(`(computation, rendering) = (${this.mscpf.toFixed(2)}, ${this.msrpf.toFixed(2)}) ms`),console.log(`Entities: ${this.world.entityCount}`),this.frames=0,this.computeTime=0,this.renderTime=0,this.started=Date.now()),setTimeout(()=>this.tick(),e)}get fps(){return this.frames/((Date.now()-this.started)/1e3)}get mspf(){return(this.computeTime+this.renderTime)/this.frames}get msrpf(){return this.renderTime/this.frames}get mscpf(){return this.computeTime/this.frames}pushState(t){this.leaveState(),this.states.push(t),this.enterState()}leaveState(){this.states[this.states.length-1].stop(this.world)}enterState(){this.states[this.states.length-1].start(this.world)}};Yt.init(),Yt.execute()}]);
//# sourceMappingURL=tlb.bundle.js.map